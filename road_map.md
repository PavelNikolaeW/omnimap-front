# OmniMap Roadmap

Файл для отслеживания планов развития и прогресса проекта.

---

## Фаза 1: Стабилизация

**Цель:** Покрыть критичный код тестами для безопасного рефакторинга.

### Задачи

- [x] Настроить Jest инфраструктуру
- [x] Тесты для `utils/functions.js` (36 тестов)
- [x] Тесты для `localStateManager.js` (20 тестов)
- [x] Тесты для `comandManager.js` (20 тестов)
- [x] Тесты для `contextManager.js` (31 тест)
- [ ] Тесты для `api.js` (отложено — singleton, нужны интеграционные тесты)

**Текущее состояние:** 107 тестов (Фаза 1 завершена)

---

## Фаза 2: Actions Layer

**Цель:** Отделить бизнес-логику от UI, чтобы и hotkeys, и LLM агенты использовали единый API.

### Архитектура

```
┌─────────────┐     ┌─────────────┐
│   Hotkeys   │     │  LLM Agent  │
└──────┬──────┘     └──────┬──────┘
       │                   │
       ▼                   ▼
┌─────────────────────────────────┐
│         Actions Layer           │
│  createBlock, moveBlock, etc.   │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│     LocalStateManager + Sync    │
└─────────────────────────────────┘
```

### Задачи

- [x] Создать `src/js/actions/` — модуль с чистыми функциями
  - [x] `blockActions.js` — CRUD операции с блоками (17 функций)
  - [x] `navigationActions.js` — навигация по дереву (20 функций)
  - [x] `selectionActions.js` — выделение и режимы (16 функций)
  - [x] `index.js` — точка входа, экспорты
  - [x] Тесты для actions (118 тестов)
- [x] Рефакторинг `comandManager` → тонкие обёртки над actions
  - [x] `commands.js` — использует actions для copy/cut/paste, навигации по деревьям
  - [x] `cmdUtils.js` — использует navigationActions для извлечения HSL и ссылок
  - [x] Константы режимов (MODES) вместо строк

**Фаза 2 завершена!** (225 тестов)

### Модель блока (backend, фиксирована)

```python
Block:
  id: UUID (PK)
  parent: FK → Block
  creator: FK → User
  title: string
  data: JSON              # ← расширения фронта здесь
  updated_at: auto

BlockPermission:
  block: FK → Block
  user: FK → User
  permission: read | write | admin
```

### Расширения в data (frontend)

```javascript
data: {
  text: string,           // содержимое блока
  color: [h, s, l],       // цвет
  view: 'iframe' | ...,   // тип отображения
  attributes: [...],      // атрибуты для iframe
  customGrid: {...},      // настройки сетки
  connections: [...],     // связи между блоками
  block_type: string,     // семантический тип (idea, task, etc)
  visual_type: string     // визуальный тип (card, note, etc)
}
```

---

## Фаза 3: LLM Chat интеграция

**Цель:** Агенты могут читать контекст графа и модифицировать блоки.

### Этап 3.1: Базовый чат (завершён)

- [x] Добавлен llm_chat как git submodule (`src/llm_chat`)
- [x] Настроен webpack для JSX и CSS Modules
- [x] Кнопка в боковой панели для открытия чата (Shift+H)
- [x] Интеграция с LLM_GATEWAY_URL из окружения
- [x] Виджет чата с потоковой передачей ответов

### Этап 3.2: Интеграция с блоками (потом)

- [ ] Маппинг графа в формат для LLM (сериализация дерева блоков)
- [ ] Системные промпты для работы с блоками
- [ ] Агенты используют `api/v1/import` для массового создания/обновления блоков
- [ ] Передача контекста текущего экрана агенту
- [ ] Обработка ответов агента и применение изменений

### Формат импорта блоков (backend api/v1/import)

```javascript
// POST /api/v1/import
{
  blocks: [
    {
      id: 'uuid',           // опционально, для обновления
      parent_id: 'uuid',
      title: 'Block title',
      data: { ... }
    },
    // ...
  ]
}
```

---

## Фаза 4: Offline + Sync

**Цель:** Приложение работает без сети, синхронизирует изменения при reconnect.

### Задачи

- [ ] Очередь операций при offline (расширить `queue.js`)
- [ ] Детекция состояния сети
- [ ] Reconnect логика в `sincManager`
- [ ] Стратегия конфликтов:
  - `creator === currentUser` → last-write-wins (автоматически)
  - shared blocks (через BlockPermission) → показать diff, спросить пользователя

---

## Фаза 5: Гибкий рендеринг

**Цель:** Разные типы блоков отображаются по-разному, настраиваемые соединения.

### Задачи

- [ ] Registry рендереров по `visual_type`
- [ ] Семантические типы влияют на контекст для LLM
- [ ] Настройка стилей соединений в `arrowManager`
- [ ] UI для выбора типа блока

### Типы блоков (TODO: продумать)

**Визуальные типы:**
- `default` — стандартный блок
- `card` — карточка с превью
- `note` — заметка/текст
- `table` — табличные данные
- `image` — изображение
- `iframe` — встроенный контент

**Семантические типы:**
- `idea` — идея
- `task` — задача
- `resource` — ресурс/ссылка
- `question` — вопрос
- `decision` — решение

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2024-12-23 | Создан roadmap, завершена настройка тестов (Фаза 1 в процессе) |
| 2024-12-23 | Добавлены тесты для comandManager и contextManager (107 тестов) |
| 2024-12-25 | Создан Actions Layer: blockActions, navigationActions, selectionActions (118 тестов, всего 225) |
| 2024-12-25 | Фаза 2 завершена. Уточнена модель блока (backend фиксирован, расширения через data JSON) |
| 2024-12-25 | Фаза 3.1: Добавлен llm_chat submodule, настроен webpack (JSX, CSS Modules), кнопка чата (Shift+H) |

---

## Заметки

- Дедлайнов нет, работаем в спокойном темпе
- Типы блоков разработаем совместно
- LLM агенты будут использовать `api/v1/import` для массового обновления блоков
