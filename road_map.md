# OmniMap Roadmap

Файл для отслеживания планов развития и прогресса проекта.

---

## Фаза 1: Стабилизация

**Цель:** Покрыть критичный код тестами для безопасного рефакторинга.

### Задачи

- [x] Настроить Jest инфраструктуру
- [x] Тесты для `utils/functions.js` (36 тестов)
- [x] Тесты для `localStateManager.js` (20 тестов)
- [x] Тесты для `comandManager.js` (20 тестов)
- [x] Тесты для `contextManager.js` (31 тест)
- [ ] Тесты для `api.js` (отложено — singleton, нужны интеграционные тесты)

**Текущее состояние:** 107 тестов (Фаза 1 завершена)

---

## Фаза 2: Actions Layer

**Цель:** Отделить бизнес-логику от UI, чтобы и hotkeys, и LLM агенты использовали единый API.

### Архитектура

```
┌─────────────┐     ┌─────────────┐
│   Hotkeys   │     │  LLM Agent  │
└──────┬──────┘     └──────┬──────┘
       │                   │
       ▼                   ▼
┌─────────────────────────────────┐
│         Actions Layer           │
│  createBlock, moveBlock, etc.   │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│     LocalStateManager + Sync    │
└─────────────────────────────────┘
```

### Задачи

- [x] Создать `src/js/actions/` — модуль с чистыми функциями
  - [x] `blockActions.js` — CRUD операции с блоками (17 функций)
  - [x] `navigationActions.js` — навигация по дереву (20 функций)
  - [x] `selectionActions.js` — выделение и режимы (16 функций)
  - [x] `index.js` — точка входа, экспорты
  - [x] Тесты для actions (118 тестов)
- [x] Рефакторинг `comandManager` → тонкие обёртки над actions
  - [x] `commands.js` — использует actions для copy/cut/paste, навигации по деревьям
  - [x] `cmdUtils.js` — использует navigationActions для извлечения HSL и ссылок
  - [x] Константы режимов (MODES) вместо строк
- [ ] Расширить модель блока (см. ниже)

### Новая модель блока

```javascript
{
  id: string,
  parent_id: string | null,
  title: string,
  content: string,
  children: string[],

  // Новые поля
  owner_id: string,           // для offline конфликтов
  block_type: string,         // семантический тип
  visual_type: string,        // визуальный тип
  style: object,              // кастомные стили
  updated_at: timestamp,
  updated_by: string          // user_id или agent_id
}
```

---

## Фаза 3: LLM Chat интеграция

**Цель:** Агенты могут читать контекст графа и модифицировать блоки.

### Задачи

- [ ] Интеграция chat frontend (готов: завтра)
- [ ] Протокол команд LLM → Actions
- [ ] Передача контекста блоков агенту
- [ ] Обработка ответов агента

### Формат команд агента (draft)

```javascript
{
  action: 'createBlock',
  params: {
    parentId: 'xxx',
    title: 'New block',
    block_type: 'task'
  }
}
```

---

## Фаза 4: Offline + Sync

**Цель:** Приложение работает без сети, синхронизирует изменения при reconnect.

### Задачи

- [ ] Очередь операций при offline (расширить `queue.js`)
- [ ] Детекция состояния сети
- [ ] Reconnect логика в `sincManager`
- [ ] Стратегия конфликтов:
  - `owner_id === currentUser` → last-write-wins (автоматически)
  - shared blocks → показать diff, спросить пользователя

---

## Фаза 5: Гибкий рендеринг

**Цель:** Разные типы блоков отображаются по-разному, настраиваемые соединения.

### Задачи

- [ ] Registry рендереров по `visual_type`
- [ ] Семантические типы влияют на контекст для LLM
- [ ] Настройка стилей соединений в `arrowManager`
- [ ] UI для выбора типа блока

### Типы блоков (TODO: продумать)

**Визуальные типы:**
- `default` — стандартный блок
- `card` — карточка с превью
- `note` — заметка/текст
- `table` — табличные данные
- `image` — изображение
- `iframe` — встроенный контент

**Семантические типы:**
- `idea` — идея
- `task` — задача
- `resource` — ресурс/ссылка
- `question` — вопрос
- `decision` — решение

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2024-12-23 | Создан roadmap, завершена настройка тестов (Фаза 1 в процессе) |
| 2024-12-23 | Добавлены тесты для comandManager и contextManager (107 тестов) |
| 2024-12-25 | Создан Actions Layer: blockActions, navigationActions, selectionActions (118 тестов, всего 225) |

---

## Заметки

- Дедлайнов нет, работаем в спокойном темпе
- LLM chat frontend будет готов 2024-12-24
- Типы блоков разработаем совместно
